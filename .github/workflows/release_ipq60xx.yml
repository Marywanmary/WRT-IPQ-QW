# IPQ60XXèŠ¯ç‰‡å¹³å°å›ºä»¶æ„å»ºå·¥ä½œæµ
name: IPQ60XXèŠ¯ç‰‡å›ºä»¶æ„å»º

on:
  # æ‰‹åŠ¨è§¦å‘æ„å»º
  workflow_dispatch:
    inputs:
      release:
        description: 'å‘å¸ƒåˆ°Release'
        type: boolean
        default: true
      clean_disk:
        description: 'æ¸…ç†ç£ç›˜ç©ºé—´'
        type: boolean
        default: true
  # å®šæ—¶è‡ªåŠ¨æ„å»ºï¼ˆæ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹ï¼‰
  schedule:
    - cron: '0 2 * * 1'

# å·¥ä½œæµä»»åŠ¡å®šä¹‰
jobs:
  # ç¬¬ä¸€å±‚ï¼šåŸºç¡€ç³»ç»Ÿç¼–è¯‘ï¼ˆå·¥å…·é“¾ + å†…æ ¸ï¼‰
  base_system:
    name: åŸºç¡€ç³»ç»Ÿç¼–è¯‘
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        branch: [immwrt, openwrt, libwrt]
      max-parallel: 3

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        if: github.event.inputs.clean_disk == 'true' || github.event_name == 'schedule'
        run: |
          echo "å¼€å§‹æ¸…ç†ç£ç›˜ç©ºé—´..."
          sudo apt-get remove -y '^php.*' || true
          sudo apt-get autoremove -y || true
          sudo apt-get autoclean || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/local/share/powershell || true
          echo "ç£ç›˜ç©ºé—´æ¸…ç†å®Œæˆ"

      - name: å®‰è£…æ„å»ºç¯å¢ƒ
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools rsync swig unzip zlib1g-dev file wget

      - name: æ¢å¤åŸºç¡€ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            openwrt/dl
            openwrt/staging_dir
          key: base-${{ github.sha }}-ipq60xx-${{ matrix.branch }}
          restore-keys: |
            base-${{ github.sha }}-ipq60xx-
            base-ipq60xx-

      - name: å…‹éš†æºç 
        run: |
          case ${{ matrix.branch }} in
            "immwrt")
              REPO_URL="https://github.com/laipeng668/immortalwrt.git"
              REPO_BRANCH="master"
              ;;
            "openwrt")
              REPO_URL="https://github.com/laipeng668/openwrt.git"
              REPO_BRANCH="master"
              ;;
            "libwrt")
              REPO_URL="https://github.com/laipeng668/openwrt-6.x.git"
              REPO_BRANCH="k6.12-nss"
              ;;
          esac
          
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
        working-directory: openwrt
        run: |
          echo "æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº..."
          echo "src-git tailscale https://github.com/tailscale/tailscale" >> feeds.conf.default
          echo "src-git sirpdboy https://github.com/sirpdboy/luci-app-taskplan" >> feeds.conf.default
          echo "src-git lucky https://github.com/gdy666/luci-app-lucky" >> feeds.conf.default
          echo "src-git momo https://github.com/nikkinikki-org/OpenWrt-momo" >> feeds.conf.default
          echo "src-git kenzo https://github.com/kenzok8/small-package" >> feeds.conf.default
          echo "ç¬¬ä¸‰æ–¹è½¯ä»¶æºæ·»åŠ å®Œæˆ"

      - name: åˆå¹¶èŠ¯ç‰‡åŸºç¡€é…ç½®
        working-directory: openwrt
        run: |
          cp ../../configs/ipq60xx_base.config .config

      - name: åŸºç¡€ç³»ç»Ÿç¼–è¯‘
        working-directory: openwrt
        run: |
          set -euxo pipefail
          exec > >(tee -a ../../build.log) 2>&1
          
          echo "å¼€å§‹åŸºç¡€ç³»ç»Ÿç¼–è¯‘: ${{ matrix.branch }}"
          make defconfig
          make download -j$(nproc)
          make tools/compile -j$(nproc)
          make toolchain/compile -j$(nproc)
          make target/compile -j$(nproc)
          echo "åŸºç¡€ç³»ç»Ÿç¼–è¯‘å®Œæˆ: ${{ matrix.branch }}"

      - name: ä¿å­˜åŸºç¡€ç¼“å­˜
        uses: actions/cache/save@v3
        with:
          path: |
            openwrt/dl
            openwrt/staging_dir
            openwrt/build_dir
          key: base-${{ github.sha }}-ipq60xx-${{ matrix.branch }}

  # ç¬¬äºŒå±‚ï¼šå¹¶è¡ŒåŒ…ç¼–è¯‘
  package_build:
    name: åŒ…ç¼–è¯‘ (${{ matrix.branch }}-${{ matrix.config }})
    needs: base_system
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - branch: immwrt
            config: Ultra
          - branch: immwrt
            config: Max
          - branch: immwrt
            config: Pro
          - branch: openwrt
            config: Ultra
          - branch: openwrt
            config: Max
          - branch: openwrt
            config: Pro
          - branch: libwrt
            config: Ultra
          - branch: libwrt
            config: Max
          - branch: libwrt
            config: Pro
      max-parallel: 9

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ¢å¤åŸºç¡€ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            openwrt/dl
            openwrt/staging_dir
            openwrt/build_dir
          key: base-${{ github.sha }}-ipq60xx-${{ matrix.branch }}

      - name: å…‹éš†æºç 
        run: |
          case ${{ matrix.branch }} in
            "immwrt")
              REPO_URL="https://github.com/laipeng668/immortalwrt.git"
              REPO_BRANCH="master"
              ;;
            "openwrt")
              REPO_URL="https://github.com/laipeng668/openwrt.git"
              REPO_BRANCH="master"
              ;;
            "libwrt")
              REPO_URL="https://github.com/laipeng668/openwrt-6.x.git"
              REPO_BRANCH="k6.12-nss"
              ;;
          esac
          
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
        working-directory: openwrt
        run: |
          echo "æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº..."
          echo "src-git tailscale https://github.com/tailscale/tailscale" >> feeds.conf.default
          echo "src-git sirpdboy https://github.com/sirpdboy/luci-app-taskplan" >> feeds.conf.default
          echo "src-git lucky https://github.com/gdy666/luci-app-lucky" >> feeds.conf.default
          echo "src-git momo https://github.com/nikkinikki-org/OpenWrt-momo" >> feeds.conf.default
          echo "src-git kenzo https://github.com/kenzok8/small-package" >> feeds.conf.default
          echo "ç¬¬ä¸‰æ–¹è½¯ä»¶æºæ·»åŠ å®Œæˆ"

      - name: åˆå¹¶å®Œæ•´é…ç½®
        working-directory: openwrt
        run: |
          ../../scripts/merge_config.sh ipq60xx ${{ matrix.branch }} ${{ matrix.config }}

      - name: å®‰è£…è½¯ä»¶åŒ…æº
        working-directory: openwrt
        run: |
          echo "æ›´æ–°å’Œå®‰è£…è½¯ä»¶åŒ…æº..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "è½¯ä»¶åŒ…æºå®‰è£…å®Œæˆ"

      - name: åŒ…ç¼–è¯‘
        working-directory: openwrt
        run: |
          set -euxo pipefail
          exec > >(tee -a ../../build.log) 2>&1
          
          echo "å¼€å§‹åŒ…ç¼–è¯‘: ${{ matrix.branch }}-${{ matrix.config }}"
          make defconfig
          make package/compile -j$(nproc)
          echo "åŒ…ç¼–è¯‘å®Œæˆ: ${{ matrix.branch }}-${{ matrix.config }}"

  # ç¬¬ä¸‰å±‚ï¼šå›ºä»¶æ‰“åŒ…
  firmware_package:
    name: å›ºä»¶æ‰“åŒ… (${{ matrix.branch }}-${{ matrix.config }})
    needs: package_build
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - branch: immwrt
            config: Ultra
          - branch: immwrt
            config: Max
          - branch: immwrt
            config: Pro
          - branch: openwrt
            config: Ultra
          - branch: openwrt
            config: Max
          - branch: openwrt
            config: Pro
          - branch: libwrt
            config: Ultra
          - branch: libwrt
            config: Max
          - branch: libwrt
            config: Pro
      max-parallel: 9

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ¢å¤åŸºç¡€ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            openwrt/dl
            openwrt/staging_dir
            openwrt/build_dir
          key: base-${{ github.sha }}-ipq60xx-${{ matrix.branch }}

      - name: å…‹éš†æºç 
        run: |
          case ${{ matrix.branch }} in
            "immwrt")
              REPO_URL="https://github.com/laipeng668/immortalwrt.git"
              REPO_BRANCH="master"
              ;;
            "openwrt")
              REPO_URL="https://github.com/laipeng668/openwrt.git"
              REPO_BRANCH="master"
              ;;
            "libwrt")
              REPO_URL="https://github.com/laipeng668/openwrt-6.x.git"
              REPO_BRANCH="k6.12-nss"
              ;;
          esac
          
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
        working-directory: openwrt
        run: |
          echo "æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº..."
          echo "src-git tailscale https://github.com/tailscale/tailscale" >> feeds.conf.default
          echo "src-git sirpdboy https://github.com/sirpdboy/luci-app-taskplan" >> feeds.conf.default
          echo "src-git lucky https://github.com/gdy666/luci-app-lucky" >> feeds.conf.default
          echo "src-git momo https://github.com/nikkinikki-org/OpenWrt-momo" >> feeds.conf.default
          echo "src-git kenzo https://github.com/kenzok8/small-package" >> feeds.conf.default
          echo "ç¬¬ä¸‰æ–¹è½¯ä»¶æºæ·»åŠ å®Œæˆ"

      - name: åˆå¹¶å®Œæ•´é…ç½®
        working-directory: openwrt
        run: |
          ../../scripts/merge_config.sh ipq60xx ${{ matrix.branch }} ${{ matrix.config }}

      - name: å®‰è£…è½¯ä»¶åŒ…æº
        working-directory: openwrt
        run: |
          echo "æ›´æ–°å’Œå®‰è£…è½¯ä»¶åŒ…æº..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "è½¯ä»¶åŒ…æºå®‰è£…å®Œæˆ"

      - name: å›ºä»¶æ‰“åŒ…
        working-directory: openwrt
        run: |
          set -euxo pipefail
          exec > >(tee -a ../../build.log) 2>&1
          
          echo "å¼€å§‹å›ºä»¶æ‰“åŒ…: ${{ matrix.branch }}-${{ matrix.config }}"
          make defconfig
          make package/install -j$(nproc)
          make target/install -j$(nproc)
          make json_overview_image_info
          make checksum
          echo "å›ºä»¶æ‰“åŒ…å®Œæˆ: ${{ matrix.branch }}-${{ matrix.config }}"

      - name: å¤„ç†æ„å»ºäº§ç‰©
        if: success()
        working-directory: openwrt
        run: |
          ../../scripts/artifacts.sh ipq60xx ${{ matrix.branch }} ${{ matrix.config }}

      - name: æ„å»ºå¤±è´¥æ—¶ä¸Šä¼ æ—¥å¿—
        if: failure()
        working-directory: openwrt
        run: |
          if [ -f "../../build.log" ]; then
            grep -i "error\|warn" ../../build.log > ../../error.log 2>/dev/null || true
            echo "=== æ„å»ºå¤±è´¥ï¼Œä¸Šä¼ æ—¥å¿— ==="
            echo "=== æ„å»ºæ—¥å¿—æœ€å100è¡Œ ==="
            tail -100 ../../build.log
          fi

      - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ipq60xx-${{ matrix.branch }}-${{ matrix.config }}-logs
          path: |
            build.log
            error.log
          if-no-files-found: ignore

  # å‘å¸ƒé˜¶æ®µ
  release:
    name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
    needs: firmware_package
    if: (github.event.inputs.release == 'true' || github.event_name == 'schedule') && success()
    runs-on: ubuntu-22.04
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: /tmp/artifacts

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        run: |
          chmod +x scripts/*.sh
          ./scripts/release.sh ipq60xx

      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ipq60xx-$(date +%Y%m%d)
          name: å›ºä»¶å‘å¸ƒ - ipq60xx - $(date +%Y-%m-%d)
          body: |
            ## ğŸ“¦ å›ºä»¶ä¿¡æ¯
            - é»˜è®¤ç®¡ç†åœ°å€ï¼š192.168.111.1
            - é»˜è®¤ç”¨æˆ·ï¼šroot
            - é»˜è®¤å¯†ç ï¼šnone
            - é»˜è®¤WIFIå¯†ç : 12345678
            
            ## ğŸ–¥ï¸ æ”¯æŒè®¾å¤‡
            - äº¬ä¸œäº‘äºšç‘Ÿ (jdcloud_re-ss-01)
            - äº¬ä¸œäº‘é›…å…¸å¨œ (jdcloud_re-cs-02)
            
            ## ğŸ“‹ åŒ…å«å†…å®¹
            - å„è®¾å¤‡å›ºä»¶ (sysupgrade & factory)
            - é…ç½®æ–‡ä»¶ (.config)
            - æ„å»ºä¿¡æ¯ (.manifest, .config.buildinfo)
            - ç¼–è¯‘æ—¥å¿— (å®Œæ•´æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—)
            - è½¯ä»¶åŒ… (ipkæ–‡ä»¶)
            
            ## ğŸ‘¤ ä½œè€…: Mary
            - å‘å¸ƒæ—¶é—´: $(date +%Y-%m-%d)
            
            ## ğŸ”§ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
            - tailscale: https://github.com/tailscale/tailscale
            - sirpdboy: https://github.com/sirpdboy/luci-app-taskplan
            - lucky: https://github.com/gdy666/luci-app-lucky
            - momo: https://github.com/nikkinikki-org/OpenWrt-momo
            - kenzok8: https://github.com/kenzok8/small-package (ä¼˜å…ˆçº§æœ€ä½)
          files: |
            /tmp/artifacts/release/ipq60xx-firmware.tar.gz
            /tmp/artifacts/release/ipq60xx-config.tar.gz
            /tmp/artifacts/release/ipq60xx-log.tar.gz
            /tmp/artifacts/release/ipq60xx-app.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
