# IPQ60XXèŠ¯ç‰‡å¹³å°å›ºä»¶æ„å»ºå·¥ä½œæµ
name: IPQ60XXèŠ¯ç‰‡å›ºä»¶æ„å»º

on:
  # æ‰‹åŠ¨è§¦å‘æ„å»º
  workflow_dispatch:
    inputs:
      release:
        description: 'å‘å¸ƒåˆ°Release'
        type: boolean
        default: true
      clean_disk:
        description: 'æ¸…ç†ç£ç›˜ç©ºé—´'
        type: boolean
        default: true
  # å®šæ—¶è‡ªåŠ¨æ„å»ºï¼ˆæ¯å‘¨ä¸€å‡Œæ™¨4ç‚¹ï¼‰
  schedule:
    - cron: '0 20 * * 1'

# ç¯å¢ƒå˜é‡å®šä¹‰
env:
  CHIP_PLATFORM: ipq60xx                    # èŠ¯ç‰‡å¹³å°å˜é‡ï¼Œä¾¿äºåç»­ä¿®æ”¹
  REPO_DIR: openwrt                         # æºç ç›®å½•
  ARTIFACTS_DIR: /tmp/artifacts             # äº§ç‰©ä¸´æ—¶ç›®å½•
  BUILD_LOG: build.log                      # æ„å»ºæ—¥å¿—æ–‡ä»¶
  ERROR_LOG: error.log                      # é”™è¯¯æ—¥å¿—æ–‡ä»¶

# å·¥ä½œæµä»»åŠ¡å®šä¹‰
jobs:
  # å‡†å¤‡é˜¶æ®µï¼šè®¾ç½®æ„å»ºçŸ©é˜µ
  prepare:
    name: å‡†å¤‡æ„å»ºç¯å¢ƒ
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        if: github.event.inputs.clean_disk == 'true' || github.event_name == 'schedule'
        uses: sbwml/actions@free-disk
        with:
          swap: 16G

      - name: è®¾ç½®æ„å»ºçŸ©é˜µ
        id: set-matrix
        run: |
          # æŒ‰ç…§Ultra->Max->Proçš„é¡ºåºæ„å»ºï¼Œä¾¿äºç¼“å­˜å‘½ä¸­
          MATRIX_JSON='{
            "branch": ["immwrt", "openwrt", "libwrt"],
            "config": ["Ultra", "Max", "Pro"],
            "include": []
          }'
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  # æ„å»ºé˜¶æ®µï¼šæ‰§è¡Œå®é™…çš„å›ºä»¶ç¼–è¯‘
  build:
    name: æ„å»º (${{ matrix.branch }}-${{ matrix.config }})
    needs: prepare
    runs-on: ubuntu-22.04
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false                      # å•ä¸ªå¤±è´¥ä¸å½±å“å…¶ä»–æ„å»º
      max-parallel: 6                       # æœ€å¤§å¹¶å‘æ•°é™åˆ¶

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        if: github.event.inputs.clean_disk == 'true' || github.event_name == 'schedule'
        uses: sbwml/actions@free-disk
        with:
          swap: 16G

      - name: å®‰è£…æ„å»ºç¯å¢ƒ
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools rsync swig unzip zlib1g-dev file wget

      - name: æ¢å¤é…ç½®ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.REPO_DIR }}/.config
          key: config-${{ matrix.branch }}-${{ env.CHIP_PLATFORM }}-${{ matrix.config }}-${{ hashFiles('configs/*.config') }}

      - name: æ¢å¤ä¸‹è½½ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.REPO_DIR }}/dl
          key: dl-${{ matrix.branch }}-${{ env.CHIP_PLATFORM }}-${{ hashFiles('configs/*.config') }}-${{ hashFiles('scripts/feeds.conf') }}
          restore-keys: |
            dl-${{ matrix.branch }}-${{ env.CHIP_PLATFORM }}-

      - name: æ¢å¤å·¥å…·é“¾ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.REPO_DIR }}/staging_dir
          key: toolchain-${{ matrix.branch }}-${{ env.CHIP_PLATFORM }}-${{ matrix.config }}-${{ hashFiles('configs/*.config') }}
          restore-keys: |
            toolchain-${{ matrix.branch }}-${{ env.CHIP_PLATFORM }}-

      - name: å…‹éš†æºç 
        run: |
          # æ ¹æ®åˆ†æ”¯è®¾ç½®å¯¹åº”çš„ä»“åº“ä¿¡æ¯
          case ${{ matrix.branch }} in
            "immwrt")
              REPO_URL="https://github.com/laipeng668/immortalwrt.git"
              REPO_BRANCH="master"
              ;;
            "openwrt")
              REPO_URL="https://github.com/laipeng668/openwrt.git"
              REPO_BRANCH="master"
              ;;
            "libwrt")
              REPO_URL="https://github.com/laipeng668/openwrt-6.x.git"
              REPO_BRANCH="k6.12-nss"
              ;;
          esac
          
          git clone $REPO_URL -b $REPO_BRANCH ${{ env.REPO_DIR }}
          cd ${{ env.REPO_DIR }}
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
        working-directory: ${{ env.REPO_DIR }}
        run: |
          echo "æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº..."
          # æ·»åŠ tailscale
          echo "src-git tailscale https://github.com/tailscale/tailscale" >> feeds.conf.default
          # æ·»åŠ sirpdboy
          echo "src-git sirpdboy https://github.com/sirpdboy/luci-app-taskplan" >> feeds.conf.default
          # æ·»åŠ lucky
          echo "src-git lucky https://github.com/gdy666/luci-app-lucky" >> feeds.conf.default
          # æ·»åŠ momo
          echo "src-git momo https://github.com/nikkinikki-org/OpenWrt-momo" >> feeds.conf.default
          # æ·»åŠ kenzok8 (ä¼˜å…ˆçº§æœ€ä½ï¼Œæ”¾åœ¨æœ€å)
          echo "src-git kenzo https://github.com/kenzok8/small-package" >> feeds.conf.default
          echo "ç¬¬ä¸‰æ–¹è½¯ä»¶æºæ·»åŠ å®Œæˆ"

      - name: åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          # ä¸ºæ‰€æœ‰è„šæœ¬èµ‹äºˆæƒé™
          chmod +x scripts/*.sh
          # æ‰§è¡Œé…ç½®åˆå¹¶
          ./scripts/merge_config.sh ${{ env.CHIP_PLATFORM }} ${{ matrix.branch }} ${{ matrix.config }}

      - name: å®‰è£…è½¯ä»¶åŒ…æº
        working-directory: ${{ env.REPO_DIR }}
        run: |
          echo "æ›´æ–°å’Œå®‰è£…è½¯ä»¶åŒ…æº..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "è½¯ä»¶åŒ…æºå®‰è£…å®Œæˆ"

      - name: æ„å»ºå›ºä»¶
        working-directory: ${{ env.REPO_DIR }}
        run: |
          set -euxo pipefail
          
          # é‡å®šå‘æ‰€æœ‰è¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶
          exec > >(tee -a ../${{ env.BUILD_LOG }}) 2>&1
          
          echo "å¼€å§‹æ„å»ºé…ç½®: ${{ matrix.branch }}-${{ matrix.config }}"
          make defconfig
          make download -j$(nproc)
          make -j$(nproc) || {
            echo "æ„å»ºå¤±è´¥ï¼Œæ­£åœ¨ä¸Šä¼ æ—¥å¿—..."
            exit 1
          }
          echo "æ„å»ºå®Œæˆ: ${{ matrix.branch }}-${{ matrix.config }}"

      - name: ä¿å­˜é…ç½®ç¼“å­˜
        uses: actions/cache/save@v3
        with:
          path: |
            ${{ env.REPO_DIR }}/.config
          key: config-${{ matrix.branch }}-${{ env.CHIP_PLATFORM }}-${{ matrix.config }}-${{ hashFiles('configs/*.config') }}

      - name: ä¿å­˜ä¸‹è½½ç¼“å­˜
        uses: actions/cache/save@v3
        with:
          path: |
            ${{ env.REPO_DIR }}/dl
          key: dl-${{ matrix.branch }}-${{ env.CHIP_PLATFORM }}-${{ hashFiles('configs/*.config') }}-${{ hashFiles('scripts/feeds.conf') }}

      - name: ä¿å­˜å·¥å…·é“¾ç¼“å­˜
        uses: actions/cache/save@v3
        with:
          path: |
            ${{ env.REPO_DIR }}/staging_dir
          key: toolchain-${{ matrix.branch }}-${{ env.CHIP_PLATFORM }}-${{ matrix.config }}-${{ hashFiles('configs/*.config') }}

      - name: å¤„ç†æ„å»ºäº§ç‰©
        if: success()
        run: |
          chmod +x scripts/*.sh
          ./scripts/artifacts.sh ${{ env.CHIP_PLATFORM }} ${{ matrix.branch }} ${{ matrix.config }}

      - name: æ„å»ºå¤±è´¥æ—¶ä¸Šä¼ æ—¥å¿—
        if: failure()
        run: |
          if [ -f "${{ env.BUILD_LOG }}" ]; then
            # æå–é”™è¯¯å’Œè­¦å‘Šä¿¡æ¯
            grep -i "error\|warn" ${{ env.BUILD_LOG }} > ${{ env.ERROR_LOG }} 2>/dev/null || true
            echo "=== æ„å»ºå¤±è´¥ï¼Œä¸Šä¼ æ—¥å¿— ==="
            echo "=== æ„å»ºæ—¥å¿—æœ€å100è¡Œ ==="
            tail -100 ${{ env.BUILD_LOG }}
          fi

      - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.CHIP_PLATFORM }}-${{ matrix.branch }}-${{ matrix.config }}-logs
          path: |
            ${{ env.BUILD_LOG }}
            ${{ env.ERROR_LOG }}
          if-no-files-found: ignore

  # å‘å¸ƒé˜¶æ®µï¼šåˆ›å»ºRelease
  release:
    name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
    needs: build
    if: (github.event.inputs.release == 'true' || github.event_name == 'schedule') && success()
    runs-on: ubuntu-22.04
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ${{ env.ARTIFACTS_DIR }}

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        run: |
          chmod +x scripts/*.sh
          ./scripts/release.sh ${{ env.CHIP_PLATFORM }}

      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.CHIP_PLATFORM }}-$(date +%Y%m%d)
          name: å›ºä»¶å‘å¸ƒ - ${{ env.CHIP_PLATFORM }} - $(date +%Y-%m-%d)
          body: |
            ## ğŸ“¦ å›ºä»¶ä¿¡æ¯
            - é»˜è®¤ç®¡ç†åœ°å€ï¼š192.168.111.1
            - é»˜è®¤ç”¨æˆ·ï¼šroot
            - é»˜è®¤å¯†ç ï¼šnone
            - é»˜è®¤WIFIå¯†ç : 12345678
            
            ## ğŸ–¥ï¸ æ”¯æŒè®¾å¤‡
            - äº¬ä¸œäº‘äºšç‘Ÿ (jdcloud_re-ss-01)
            - äº¬ä¸œäº‘é›…å…¸å¨œ (jdcloud_re-cs-02)
            
            ## ğŸ“‹ åŒ…å«å†…å®¹
            - å„è®¾å¤‡å›ºä»¶ (sysupgrade & factory)
            - é…ç½®æ–‡ä»¶ (.config)
            - æ„å»ºä¿¡æ¯ (.manifest, .config.buildinfo)
            - ç¼–è¯‘æ—¥å¿— (å®Œæ•´æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—)
            - è½¯ä»¶åŒ… (ipk/apkæ–‡ä»¶)
            
            ## ğŸ‘¤ ä½œè€…: Mary
            - å‘å¸ƒæ—¶é—´: $(date +%Y-%m-%d)
            
            ## ğŸ”§ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
            - tailscale: https://github.com/tailscale/tailscale
            - sirpdboy: https://github.com/sirpdboy/luci-app-taskplan
            - lucky: https://github.com/gdy666/luci-app-lucky
            - momo: https://github.com/nikkinikki-org/OpenWrt-momo
            - kenzok8: https://github.com/kenzok8/small-package (ä¼˜å…ˆçº§æœ€ä½)
          files: |
            ${{ env.ARTIFACTS_DIR }}/release/${{ env.CHIP_PLATFORM }}-firmware.tar.gz
            ${{ env.ARTIFACTS_DIR }}/release/${{ env.CHIP_PLATFORM }}-config.tar.gz
            ${{ env.ARTIFACTS_DIR }}/release/${{ env.CHIP_PLATFORM }}-log.tar.gz
            ${{ env.ARTIFACTS_DIR }}/release/${{ env.CHIP_PLATFORM }}-app.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
